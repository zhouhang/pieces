<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>新建报价-boss</title>
    <meta name="renderer" content="webkit" />
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>
    <!-- fa-floor start -->
    <div class="create-enquiry2 chart">
        <div class="thead">
            <table>
                <thead>
                    <tr>
                        <th width="150">商品名称</th>
                        <th width="150">片型</th>
                        <th>规格等级</th>
                        <th width="120">产地</th>
                        <th width="120">单价（元/公斤）</th>
                        <th width="120">操作</th>
                    </tr>
                </thead>
            </table>
        </div>
        <form action="" id="myform">
            <table>
                <thead class="hide">
                    <tr>
                        <th width="150">商品名称</th>
                        <th width="150">片型</th>
                        <th>规格等级</th>
                        <th width="120">产地</th>
                        <th width="120">单价（元/公斤）</th>
                        <th width="120">操作</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
            <div class="tfoot">
                <button type="submit" class="btn btn-red" id="submit">报价</button>
                <span>报价有效期至：</span>
                <input type="text" name="date" id="date" class="ipt" autocomplete="off">
            </div>
        </form>
    </div>


    <!-- 输入框联想 start -->
    <div class="suggestions" id="suggestions" style="width:860px;">
        <div class="hd">
            <div class="group">
                <span class="w1">商品名称</span><span class="w2">片型</span><span class="w3">规格等级</span><span class="w4">产地</span><span class="w5">当前价格</span><span class="w6">上次成交价格</span>
            </div>
        </div>
        <div class="bd"></div>
    </div><!-- 输入框联想 end -->

    <script type="temp" id="jmodal">
        <tr>
            <td width="150">
                <div class="inner pr">
                    <input type="text" class="ipt name" name="title" autocomplete="off">
                    <span class="error1"></span>
                </div>
            </td>
            <td width="150">
                <div class="inner pr">
                    <input type="text" class="ipt" name="spec" autocomplete="off">
                </div>
            </td>
            <td>
                <div class="inner pr">
                    <input type="text" class="ipt" name="level" autocomplete="off">
                </div>
            </td>
            <td width="120">
                <div class="inner pr">
                    <input type="text" class="ipt" name="originof" autocomplete="off">
                </div>
            </td>
            <td width="120">
                <div class="inner pr">
                    <input type="text" class="ipt price" name="price" value="" autocomplete="off">
                </div>
            </td>
            <td width="120">
                <a href="javascript:;" class="remove c-red">删除</a>
            </td>
        </tr>
    </script>
    <script src="js/jquery.min.js"></script>
    <script src="js/smartZoom.js"></script>
    <script src="js/laydate/laydate.js"></script>
    <script src="js/layer/layer.js"></script>
    <script src="js/jquery.pagination.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        var enquiryPage = {
            v: {},
            fn: {
                init: function() {
                    this.myformEvent();
                    this.pic();
                },
                pic: function() {
                    var imgList = ['http://192.168.1.51/static/uploads/c.jpg','http://static.sghaoyao.com/anon/2017/3/d7685ba4-320e-4026-a7e3-cf2dd8f2bc5f.jpg','http://192.168.1.51/static/uploads/a.jpg','http://192.168.1.51/static/uploads/b.jpg','http://192.168.1.51/static/uploads/c.jpg','http://192.168.1.51/static/uploads/d.jpg','http://192.168.1.51/static/uploads/d.jpg','http://192.168.1.51/static/uploads/d.jpg','http://192.168.1.51/static/uploads/d.jpg'],
                        templete = '<div class="pic-fixed"> \n <div class="img"><img src="images/blank.gif"></div> \n <div class="thumb"></div></div>',
                        pages = [],
                        $pic, img;

                    // 缩放图片
                    var zoomImg = function() {
                        $(img).smartZoom('destroy');
                        $(img).smartZoom();
                    }

                    if (imgList.length === 0) {
                        return this;
                    }

                    $('body').append(templete);
                    $pic = $('.pic-fixed');
                    img = $pic.find('.img img')[0];
                    // 显示第一张图片
                    img.src = imgList[0];
                    // 生成分页
                    $.each(imgList, function(i, url) {
                        pages.push('<span><img src="', url, '" /></span>');
                    })
                    $pic.find('.thumb').html(pages.join('')).find('span:eq(0)').addClass('curr');

                    // 切换图片
                    $pic.on('click', '.thumb img', function() {
                        img.src = this.src;
                        zoomImg();
                        $(this).parent().addClass('curr').siblings().removeClass('curr');
                    })

                    zoomImg();
                },
                myformEvent: function() {
                    var $body        = $('body');
                    var $suggestions = $('#suggestions');
                    var $tbody       = $('#tbody');
                    var $ipt         = $tbody.find('.ipt:first');
                    var $date        = $('#date');
                    var html         = $('#jmodal').html();
                    var self         = this;
                    var count        = 13;
                    var model        = [];

                    while (count-- > 0) {
                        model.push(html);
                    }
                    $tbody.append(model.join(''));

                    // 单价
                    $tbody.on('keyup', '.price', function(e) {
                        var val = this.value;
                        if (!/^\d+\.?\d*$/.test(val)) {
                            val = Math.abs(parseFloat(val));
                            this.value = isNaN(val) ? '' : val;
                        }
                        if (e.keyCode === 13) {
                            $(this).closest('tr').next().find('.price').focus();
                        }
                    })

                    var checked = function() {
                        var pass = false;
                        $tbody.find('.name').each(function() {
                            if (this.value != '') {
                                pass = true;
                                return false;
                            }
                        })

                        !pass && $.notify({
                            title: '最少填写一条报价',
                            type: 'error',
                            delay: 2e3
                        })

                        return pass;
                    }
                    
                    // 提交
                    $('#submit').on('click', function() {
                        var val = $date.val(),
                            pass = checked();

                            layer.open({
                                title: '提交成功',
                                content: '你的报价已提交成功',
                                time: 3e3,
                                btn: ['关闭'],
                                btn1: function(index) {
                                    layer.close(index);
                                    var params = getParams() || {};
                                    if (params['url']) {
                                        window.location.href = params['url'];
                                    }
                                }
                            })
                        if (pass && !val) {
                            $.notify({
                                title: '请填写报价有效期',
                                type: 'error',
                                delay: 2e3
                            })
                            $date.focus();
                            pass = false;
                        } else {
                            // 验证通过，准备提交
                            console.log(9)
                        }
                        return false;
                    })

                    // 商品名联想
                    $tbody.on({
                        'click': function(event) {
                            event.stopPropagation();
                        },
                        'focus': function() {
                            // $(this).siblings('.error1').hide();
                            $(this).after($suggestions);
                            $suggestions.find('.group').length > 1 && $suggestions.show();
                        },
                        'input': function() {
                            self.getKeywords(this.value);                           
                        }
                    }, '.name');

                    // 关闭联想层
                    $body.on('click', function() {
                        $suggestions.hide();
                    })
                    $body.on('click', '.suggestions', function(event) {
                        event.stopPropagation();
                    })

                    // 关键字自动填充
                    $body.on('click', '.suggestions .bd .group', function() {
                        var data = $(this).data('val').split('-');
                        $suggestions.prev().val(data[0])
                        .closest('td').next().find('.ipt').val(data[1]).trigger('focus').end()
                        .closest('td').next().find('.ipt').val(data[2]).trigger('focus').end()
                        .closest('td').next().find('.ipt').val(data[3]).trigger('focus').end()
                        .closest('tr').find('.remove').show();
                        $suggestions.hide();

                        var length = 0;
                        $('.name').each(function() {
                            length += this.value == '' ? 1 : 0;
                        })
                        if (length < 4) {
                            $tbody.append(model.join(''));
                        }
                    })

                    // 删除一行
                    $tbody.on('click', '.remove', function() {
                        $(this).closest('tr').remove();
                    })

                    // 有效期
                    laydate({
                        elem: '#date',
                        istime: true,
                        choose: function(datas){
                        }
                    })
                },
                // ajax 查询关键词
                getKeywords: function(keywords) {
                    var self = this;
                    var keywords = $.trim(keywords);
                    if (keywords === '') {
                        $('#suggestions').hide();
                    } else {
                        // ajax 查询关键词
                        self.timer && clearTimeout(self.timer);
                        self.timer = setTimeout(function() {
                            self.ajaxSearch();
                        }, 500);                
                    }               
                },
                ajaxSearch: function() {
                    var self = this;
                    $.ajax({
                        url: 'json/keywords.php',
                        dataType: 'json',
                        success: function(data) {
                            // 显示查询结果 
                            if (data.status === 'success') {
                                if (data.list.length === 0) {
                                    $('#suggestions').show().find('.bd').empty().html('暂无此商品:)');
                                } else {
                                    self.toHtml(data.list, 0 ,7);
                                }
                            } else {
                                $('#suggestions').hide();
                            }
                        }
                    })
                },
                // 显示查询结果
                toHtml: function(item, page_index, pageSize) {
                    var modal = [],
                        maxPage = Math.min((page_index + 1) * pageSize, item.length),
                        hasPage = pageSize < item.length;

                    for (var i = page_index * pageSize; i < maxPage; i++) {
                        var val = item[i].name + '-' + item[i].spec + '-' + item[i].level + '-' + item[i].originOf;
                        modal.push('<div class="group" data-val="', val, '">');
                        modal.push(     '<span class="w1">', item[i].name, '</span>');
                        modal.push(     '<span class="w2">', item[i].spec, '</span>');
                        modal.push(     '<span class="w3">', item[i].level, '</span>');
                        modal.push(     '<span class="w4">', item[i].originOf, '</span>');
                        modal.push(     '<span class="w4">&yen;22</span>');
                        modal.push('</div>');
                    }
                    hasPage && modal.push('<div class="jq-page"></div>');
                    $('#suggestions').show().find('.bd').empty().html(modal.join(''));
                    hasPage && this.showPage(item, page_index, pageSize);
                },
                showPage: function(item, page_index, pageSize) {
                    var self = this;
                    $('.jq-page').pagination(item.length, {
                        items_per_page: pageSize, //pageSize 每页显示数量
                        current_page: page_index, //默认pageIndex,0(默认),false(不加载)
                        num_edge_entries: 2, //1(任何情况下都显示第一页和最后一页),0(不显示)
                        callback: function(page_index) {
                            self.toHtml(item, page_index, pageSize);
                        }
                    })
                    $('.jq-page').prepend('<div class="p-size">总共' + item.length + '条记录</div>')
                }
            }
        }
        $(function() {
            enquiryPage.fn.init();
        })
    </script>
</body>
</html>

<script>
// 以下js为本地导航模板代码，上线时请删掉
$(function() {
    $.ajax({
        url: 'nav.html',
        success: function(menu) {
            $('.nav').html(menu);

            var $side = $('.nav'),
                URL = document.URL.split('#')[0].split('?')[0].toLowerCase();

            $side.find('a').each(function() {
                if (URL === this.href.toLowerCase()) {
                    $(this).addClass("on").parent().prev().addClass('curr');
                    return false; // break
                }
            }) 
        }
    })
})
</script>